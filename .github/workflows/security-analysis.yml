name: Security Analysis

on:
  push:
    branches: [ main, develop, 001-build-a-simple ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install Foundry
      uses: foundry-rs/foundry-toolchain@v1
      with:
        version: nightly
    
    - name: Install dependencies
      run: |
        cd contracts
        forge install
    
    - name: Run Foundry tests
      run: |
        cd contracts
        forge test --gas-report
    
    - name: Run Foundry security profile tests
      run: |
        cd contracts
        forge test --match-path "test/{Security,VRFSecurity}.t.sol"
    
    - name: Install Slither
      run: |
        pip3 install slither-analyzer
    
    - name: Run Slither analysis
      run: |
        cd contracts
        slither . --config-file slither.config.json --sarif results.sarif
      continue-on-error: true
    
    - name: Upload Slither SARIF results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: contracts/results.sarif
    
    - name: Check for HIGH severity issues
      run: |
        cd contracts
        slither . --config-file slither.config.json --print human-summary --fail-high
    
    - name: Run invariant tests
      run: |
        cd contracts
        forge test --match-contract InvariantWeightsTest -vvv
    
    - name: Generate coverage report
      run: |
        cd contracts
        forge coverage --report lcov
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: contracts/lcov.info
        flags: contracts
        name: contracts-coverage
